name: TVBox Sites Merges

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  merge-sites:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: leexuben/BINGO-TV
        path: bingo-tv
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests

    - name: Merge and fix sites
      run: |
        python << 'EOF'
        import json
        import requests
        
        # æºæ–‡ä»¶åˆ—è¡¨
        sources = [
            {
                "url": "https://hub.gitmirror.com/raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/ç‹äºŒå°/api.json",
                "jar": "https://raw.githubusercontent.com/leexuben/TV-BOX/mainæç‹/tvbox/ç‹äºŒå°/spider.jar",
                "base": "æç‹://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/ç‹äºŒå°/"
            },
            {
                "url": "https://hub.gitmirror.com/raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/æ½‡æ´’/api.json", 
                "jar": "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/æ½‡æ´’/spider.jar",
                "base": "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/æ½‡æ´’/"
            },
            {
                "url": "https://hub.gitmirror.com/raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/å·§æŠ€/api.json",
                "jar": "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/å·§æŠ€/spider.jar", 
                "base": "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/å·§æŠ€/"
            },
            {
                "url": "https://hub.gitmirror.com/raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/å½±è§†",
                "jar": "https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/jar/spider.jar",
                "base": "https://raw.githubusercontent.com/leæç‹/ljlfct01.github.io/main/"
            }
        ]
        
        target_file = "bingo-tv/ç»¼åˆå½±è§†.json"
        
        def get_sites_from_url(url):
            try:
                response = requests.get(url, timeout=10)
                if response.status_code == 200:
                    content = response.text
                    try:
                        data = json.loads(content)
                        if isinstance(data, dict) and 'sites' in data:
                            return data['sites']
                        elif isinstance(data, list):
                            return data
                    except:
                        start = content.find('{')
                        end = content.rfind('}') + 1
                        if start != -1 and end != -1:
                            data = json.loads(content[start:end])
                            if isinstance(data, dict) and 'æç‹' in data:
                                return data['sites']
                            elif isinstance(data, list):
                                return data
                return []
            except:
                return []
        
        def fix_site_paths(site, base_url, jar_url):
            # æ·»åŠ jar
            if 'jar' not in site:
                site['jar'] = jar_url
            
            # ä¿®å¤ç›¸å¯¹è·¯å¾„
            if 'api' in site and isinstance(site['api'], str) and site['api'].startswith('./'):
                site['api'] = base_url + site['api'][2:]
            
            if 'ext' in site and isinstance(site['ext'], str) and site['ext'].startswith('./'):
                site['ext'] = base_url + site['ext'][2:]
                
            return site
        
        # è¯»å–ç›®æ ‡æ–‡ä»¶
        try:
            with open(target_file, 'r', encoding='utf-8') as f:
                target_data = json.load(f)
        except:
            target_data = {}
        
        # ç¡®ä¿æœ‰sitesæ•°ç»„
        if 'sites' not in target_data:
            target_data['sites'] = []
        
        existing_sites = target_data['sites']
        existing_keys = set()
        
        for site in existing_sites:
            key = site.get('key', '')
            if key:
                existing_keys.add(key)
        
        # åˆå¹¶æ‰€æœ‰æº
        for source in sources:
            sites = get_sites_from_url(source['url'])
            for site in sites:
                # å¤„ç†ç«™ç‚¹
                fixed_site = fix_site_paths(site, source['base'], source['jar'])
                
                # å»é‡
                key = fixed_site.get('key', '')
                if key and key not in existing_keys:
                    existing_sites.append(fixed_site)
                    existing_keys.add(key)
        
        # æ›´æ–°ç›®æ ‡æ•°æ®
        target_data['sites'] = existing_sites
        
        # ä¿å­˜
        with open(target_file, 'w', encoding='utf-8')æç‹ f:
            json.dump(target_data, f, ensure_ascii=False, indent=2)
        
        print("åˆå¹¶å®Œæˆ")
        EOF

    - name: Test result
      run: |
        cd bingo-tv
        echo "=== æµ‹è¯•åˆå¹¶ç»“æœ ==="
        
        if [ -f "ç»¼åˆå½±è§†.json" ]; then
            echo "âœ… æ–‡ä»¶å­˜åœ¨"
            filesize=$(wc -c < "ç»¼åˆå½±è§†.json")
            echo "æ–‡ä»¶å¤§å°: ${filesize} bytes"
            
            python3 -c "
import json
try:
    with open('ç»¼åˆå½±è§†.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    sites_count = len(data.get('sites', []))
    print(f'ç«™ç‚¹æ•°é‡: {sites_count}')
    if sites_count > 0:
        print('å‰3ä¸ªç«™ç‚¹ç¤ºä¾‹:')
        for i, site in enumerate(data['sites'][:3]):
            name = site.get('name', 'æœªçŸ¥')
            key = site.get('key', 'æ— key')
            api = site.get('api', 'æ— api')
            jar = site.get('jar', 'æ— jar')
            print(f'  {i+1}. {name}')
            print(f'     key: {key}')
            if api and api.startswith('http'):
                print(f'     api: {api[:50]}...')
            if jar and jar.startswith('http'):
                print(f'     jar: {jar[:50]}...')
            print('     ---')
except Exception as e:
    print(f'è§£æé”™è¯¯: {e}')
"
        else
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨"
        fi

    - name: Commit and push changes
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        cd bingo-tv
        
        # é…ç½®Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/leexuben/BINGO-TV.git
        
        # æ£€æŸ¥æ–‡ä»¶çŠ¶æ€
        echo "=== æ–‡ä»¶çŠ¶æ€ ==="
        git status
        
        # æ£€æŸ¥æ–‡ä»¶å·®å¼‚
        echo "=== æ–‡ä»¶å·®å¼‚ ==="
        git diff ç»¼åˆå½±è§†.json || echo "æ— å·®å¼‚"
        
        # æ·»åŠ æ–‡ä»¶
        git add ç»¼åˆå½±è§†.json
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --cached --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
          exit 0
        fi
        
        # æäº¤æ›´æ”¹
        git commit -m "Auto-update: Merged sites data $(date +'%Y-%m-%d %H:%M:%S')"
        
        # æ¨é€æ›´æ”¹
        git push origin main
        
        echo "âœ… ç«™ç‚¹æ•°æ®åˆå¹¶å®Œæˆå¹¶å·²æ¨é€"
