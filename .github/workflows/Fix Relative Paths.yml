name: Fix Relative Paths

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  fix-paths:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: leexuben/BINGO-TV
        path: bingo-tv
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Fix relative paths script
      run: |
        python << 'EOF'
        import json
        import os

        # é…ç½®æ–‡ä»¶è·¯å¾„
        SOURCE_FILE = "bingo-tv/ç»¼åˆå½±è§†.json"
        TARGET_FILE = "bingo-tv/ç»¼åˆå½±è§†.json"
        
        # åŸºç¡€URLé…ç½®
        BASE_URLS = {
            "ç‹äºŒå°": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/ç‹äºŒå°/",
            "æ½‡æ´’": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/æ½‡æ´’/",
            "å·§æŠ€": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tæç‹/å·§æŠ€/",
            "å½±è§†": "https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/refs/heads/main/"
        }

        def fix_relative_paths(sites):
            """ä¿®å¤ç›¸å¯¹è·¯å¾„ä¸ºå®Œæ•´è·¯å¾„"""
            fixed_count = 0
            
            for site in sites:
                # ä¿®å¤ api å­—æ®µ
                if 'api' in site and isinstance(site['api'], str) and site['api'].startswith('./'):
                    original_path = site['api']
                    # æ ¹æ®jarå­—æ®µåˆ¤æ–­æ¥æº
                    jar_url = site.get('jar', '')
                    base_url = None
                    
                    # æ ¹æ®jar URLåˆ¤æ–­æ¥æº
                    if 'ç‹äºŒå°' in jar_url:
                        base_url = BASE_URLS['ç‹äºŒå°']
                    elif 'æ½‡æ´’' in jar_url:
                        base_url = BASE_URLS['æ½‡æ´’']
                    elif 'å·§æŠ€' in jar_url:
                        base_url = BASE_URLS['å·§æŠ€']
                    elif 'ljlfct01' in jar_url:
                        base_url = BASE_URLS['å½±è§†']
                    
                    if base_url:
                        # ç§»é™¤ ./ å‰ç¼€å¹¶æ„å»ºå®Œæ•´URL
                        relative_path = original_path[2:]  # ç§»é™¤ './'
                        site['api'] = base_url + relative_path
                        fixed_count += 1
                        print(f"  ä¿®å¤ api: {original_path} -> {site['api']}")

                # ä¿®å¤ ext å­—æ®µ
                if 'ext' in site and isinstance(site['ext'], str) and site['ext'].startswith('./'):
                    original_path = site['ext']
                    jar_url = site.get('jar', '')
                    base_url = None
                    
                    if 'ç‹äºŒå°' in jar_url:
                        base_url = BASE_URLS['ç‹äºŒå°']
                    elif 'æ½‡æ´’' in jar_url:
                        base_url = BASE_URLS['æ½‡æ´’']
                    elif 'å·§æŠ€' in jar_url:
                        base_url = BASE_URLS['å·§æŠ€']
                    elif 'ljlfct01' in jar_url:
                        base_url = BASE_URLS['å½±è§†']
                    
                    if base_url:
                        relative_path = original_path[2:]
                        site['ext'] = baseæç‹ + relative_path
                        fixed_count += 1
                        print(f"  ä¿®å¤ ext: {original_path} -> {site['ext']}")

            return fixed_count

        def main():
            print("ğŸš€ å¼€å§‹ä¿®å¤ç›¸å¯¹è·¯å¾„...")
            print("=" * 60)
            
            # è¯»å–æºæ–‡ä»¶
            try:
                with open(SOURCE_FILE, 'r', encoding='utf-8') as f:
                    data = f.read()
                
                # è§£æJSON
                json_data = json.loads(data)
                
                # æ£€æŸ¥æ•°æ®ç»“æ„
                if 'sites' in json_data:
                    # å¯¹è±¡æ ¼å¼ï¼šåŒ…å«siteså’Œå…¶ä»–å­—æ®µ
                    print("ğŸ“Š æ£€æµ‹åˆ°å¯¹è±¡æ ¼å¼ï¼ŒåŒ…å«siteså’Œå…¶ä»–å­—æ®µ")
                    sites = json_data['sites']
                    other_fields = {k: v for k, v in json_data.items() if k != 'sites'}
                    
                    print(f"ğŸ“Š æ‰¾åˆ° {len(sites)} ä¸ªç«™ç‚¹")
                    print(f"ğŸ“Š å…¶ä»–å­—æ®µ: {list(other_fields.keys())}")
                    
                    # ä¿®å¤ç›¸å¯¹è·¯å¾„
                    fixed_count = fix_relative_paths(sites)
                    print(f"âœ… ä¿®å¤äº† {fixed_count} ä¸ªç›¸å¯¹è·¯å¾„")
                    
                    # é‡æ–°æ„å»ºå®Œæ•´æ•°æ®
                    result_data = {'sites': sites}
                    result_data.update(other_fields)
                    
                else:
                    # ç›´æ¥æ˜¯æ•°ç»„æ ¼å¼
                    print("ğŸ“Š æ£€æµ‹åˆ°æ•°ç»„æ ¼å¼")
                    sites = json_data
                    print(f"ğŸ“Š æ‰¾åˆ° {len(sites)} ä¸ªç«™ç‚¹")
                    
                    # ä¿®å¤ç›¸å¯¹è·¯å¾„
                    fixed_count = fix_relative_paths(sites)
                    print(f"âœ… ä¿®å¤äº† {fixed_count} ä¸ªç›¸å¯¹è·¯å¾„")
                    
                    result_data = sites
                
                # ä¿å­˜ä¿®å¤åçš„æ•°æ®ï¼ˆä¿ç•™åŸå§‹ç»“æ„ï¼‰
                with open(TARGET_FILE, 'w', encoding='utf-8') as f:
                    json.dump(result_data, f, ensure_ascii=False, indent=2)
                
                print("=" * 60)
                print("ğŸ“‹ ä¿®å¤åçš„ç¤ºä¾‹:")
                
                if isinstance(result_data, dict) and 'sites' in result_data:
                    for i, site in enumerate(result_data['sites'][:3]):
                        name = site.get('name', 'æœªçŸ¥åç§°')
                        key = site.get('key', 'æ— key')
                        api = site.get('api', 'æ— api')
                        ext = site.get('ext', 'æ— ext')
                        print(f"  {i+1}. {name} (key: {key})")
                        if api and api.startswith('http'):
                            print(f"     api: {api}")
                        if ext and ext.startswith('http'):
                            print(f"     ext: {ext}")
                        print("     ---")
                else:
                    for i, site in enumerate(result_data[:3]):
                        name = site.get('name', 'æœªçŸ¥åç§°')
                        key = site.get('key', 'æ— key')
                        api = site.get('api', 'æ— api')
                        ext = site.get('ext', 'æ— ext')
                        print(f"  {i+1}. {name} (key: {key})")
                        if api and api.startswith('http'):
                            print(f"     api: {api}")
                        if ext and ext.startswith('http'):
                            print(f"     ext: {ext}")
                        print("     ---")
                    
            except Exception as e:
                print(f"âŒ å¤„ç†æ–‡ä»¶å¤±è´¥: {e}")
                return False
                
            return True

        if __name__ == "__main__":
            main()
        EOF

    - name: Commit and push changes
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        cd bingo-tv
        
        # é…ç½®Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/leexuben/BINGO-TV.git
        
        # æ£€æŸ¥æ–‡ä»¶çŠ¶æ€
        echo "=== æ–‡ä»¶çŠ¶æ€ ==="
        git status
        
        # æ£€æŸ¥æ–‡ä»¶å·®å¼‚
        echo "=== æ–‡ä»¶å·®å¼‚ ==="
        git diff ç»¼åˆå½±è§†.json || echo "æ— å·®å¼‚"
        
        # æ·»åŠ æ–‡ä»¶
        git add ç»¼åˆå½±è§†.json
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --cached --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
          exit 0
        fi
        
        # æäº¤æ›´æ”¹
        git commit -m "Fix: Convert relative paths to absolute URLs $(date +'%Y-%m-%d %H:%M:%S')"
        
        # æ¨é€æ›´æ”¹
        git push origin main
        
        echo "âœ… ç›¸å¯¹è·¯å¾„ä¿®å¤å®Œæˆå¹¶å·²æ¨é€"
