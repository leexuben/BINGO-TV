name: Merge Sites Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  merge-sites:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: leexuben/BINGO-TV
        path: bingo-tv
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: Install jq for JSON processing
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Download and merge sites data
      run: |
        cd bingo-tv
        
        # 创建临时目录
        mkdir -p temp
        
        # 下载各个源文件
        curl -s -o temp/wang.json "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/王二小/api.json"
        curl -s -o temp/xiao.json "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/潇洒/api.json"  
        curl -s -o temp/qiao.json "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/巧技/api.json"
        curl -s -o temp/li.json "https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/影视"
        
        # 读取目标文件（保留原有结构）
        if [ -f "综合影视.json" ]; then
          cp "综合影视.json" temp/merged.json
        else
          echo '{}' > temp/merged.json
        fi
        
        # 提取各源的sites数组并添加jar字段
        echo '[]' > temp/all_sites.json
        
        # 处理王二小源
        if [ -s temp/wang.json ]; then
          jq '.sites // [] | map(. + {"jar": "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/王二小/spider.jar"})' temp/wang.json > temp/wang_sites.json
          jq '. + input' temp/all_sites.json temp/wang_sites.json > temp/temp1.json
          mv temp/temp1.json temp/all_sites.json
        fi
        
        # 处理潇洒源
        if [ -s temp/xiao.json ]; then
          jq '.sites // [] | map(. + {"jar": "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/潇洒/spider.jar"})' temp/xiao.json > temp/xiao_sites.json
          jq '. + input' temp/all_sites.json temp/xiao_sites.json > temp/temp2.json
          mv temp/temp2.json temp/all_sites.json
        fi
        
        # 处理巧技源
        if [ -s temp/qiao.json ]; then
          jq '.sites // [] | map(. + {"jar": "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/巧技/spider.jar"})' temp/qiao.json > temp/qiao_sites.json
          jq '. + input' temp/all_sites.json temp/qiao_sites.json > temp/temp3.json
          mv temp/temp3.json temp/all_sites.json
        fi
        
        # 处理第四个源
        if [ -s temp/li.json ]; then
          jq '.sites // [] | map(. + {"jar": "https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/jar/spider.jar"})' temp/li.json > temp/li_sites.json
          jq '. + input' temp/all_sites.json temp/li_sites.json > temp/temp4.json
          mv temp/temp4.json temp/all_sites.json
        fi
        
        # 去重（基于key字段）
        jq 'group_by(.key) | map(.[0])' temp/all_sites.json > temp/unique_sites.json
        
        # 更新目标文件，只替换sites字段，其他字段保持不变
        jq '.sites = input' temp/merged.json temp/unique_sites.json > 综合影视.json
        
        # 统计信息
        total_count=$(jq 'length' temp/all_sites.json)
        unique_count=$(jq '.sites | length' 综合影视.json)
        echo "合并完成: 总${total_count}个站点, 去重后${unique_count}个站点"
        
        # 显示文件结构
        echo "=== 文件结构 ==="
        jq 'keys' 综合影视.json
        
        # 清理临时文件
        rm -rf temp

    - name: Check merged result
      run: |
        cd bingo-tv
        echo "=== 文件内容预览 ==="
        jq '.' 综合影视.json | head -50
        echo "=== 站点统计 ==="
        jq '.sites | length' 综合影视.json
        echo "=== 有jar字段的站点 ==="
        jq '.sites | map(select(.jar)) | length' 综合影视.json

    - name: Commit and push changes
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        cd bingo-tv
        
        # 配置Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/leexuben/BINGO-TV.git
        
        # 检查文件差异
        echo "=== 文件差异 ==="
        git diff 综合影视.json || echo "无差异"
        
        # 添加文件
        git add 综合影视.json
        
        # 检查是否有更改
        if git diff --cached --quiet; then
          echo "❌ 没有检测到更改"
          exit 1
        fi
        
        # 提交并推送
        git commit -m "Auto-update: Merged sites data with jar fields"
        git push origin main
        
        echo "✅ 文件已成功更新并推送"
