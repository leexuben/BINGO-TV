name: TVBox Complete Merge

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  complete-merge:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: leexuben/BINGO-TV
        path: bingo-tv
        token: ${{ secrets.GH_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests

    - name: Merge all sources with full features
      run: |
        cd bingo-tv
        python3 -c "
import json
import requests

# æºæ–‡ä»¶é…ç½®
sources = [
    {
        'url': 'https://hub.gitmirror.com/raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/ç‹äºŒå°/api.json',
        'jar': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/ç‹äºŒå°/spider.jar',
        'base': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/ç‹äºŒå°/'
    },
    {
        'url': 'https://hub.gitmirror.com/raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/æ½‡æ´’/api.json',
        'jar': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/æ½‡æ´’/spider.jar',
        'base': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/æ½‡æ´’/'
    },
    {
        'url': 'https://hub.gitmirror.com/raw.githubusercontent.com/leæç‹/TV-BOX/refs/heads/main/tvbox/å·§æŠ€/api.json',
        'jar': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/å·§æŠ€/spider.jar',
        'base': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/å·§æŠ€/'
    },
    {
        'url': 'https://hub.gitmirror.com/raw.githubusercontent.com/leexuben/ljlfct01.github.io/refs/heads/main/å½±è§†',
        'jar': 'https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/jar/spider.jar',
        'base': 'https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/'
    }
]

target_file = 'ç»¼åˆå½±è§†.json'

# è¯»å–ç›®æ ‡æ–‡ä»¶ï¼ˆä¿ç•™æ‰€æœ‰å…¶ä»–é›†åˆï¼‰
try:
    with open(target_file, 'r', encoding='utf-8') as f:
        target_data = json.load(f)
except:
    target_data = {}

# ç¡®ä¿æœ‰sitesæ•°ç»„
if 'sites' not in target_data:
    target_data['sites'] = []

existing_sites = target_data['sites']
existing_keys = {site.get('key', '') for site in existing_sites}

# å¤„ç†æ¯ä¸ªæºæ–‡ä»¶
for source in sources:
    try:
        response = requests.get(source['url'], timeout=30)
        if response.status_code == 200:
            data = json.loads(response.text)
            
            # æå–sitesæ•°ç»„
            if isinstance(data, dict) and 'sites' in data:
                sites = data['sites']
            elif isinstance(data, list):
                sites = data
            else:
                sites = []
            
            # å¤„ç†æ¯ä¸ªç«™ç‚¹
            for site in sites:
                # å¤åˆ¶ç«™ç‚¹æ•°æ®ï¼ˆä¿æŒæ‰€æœ‰å­—æ®µï¼‰
                new_site = site.copy()
                
                # 1. æ·»åŠ jarï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
                if 'jar' not in new_site or not new_site['jar']:
                    new_site['jar'] = source['jar']
                
                # 2. ä¿®å¤ç›¸å¯¹è·¯å¾„
                if 'api' in new_site and isinstance(new_site['api'], str) and new_site['api'].startswith('./'):
                    new_site['api'] = source['base'] + new_site['api'][2:]
                
                if 'ext' in new_site and isinstance(new_site['ext'], str) and new_site['ext'].startswith('./'):
                    new_site['ext'] = source['base'] + new_site['ext'][2:]
                
                # 3. å»é‡æ·»åŠ ï¼ˆåŸºäºkeyå­—æ®µï¼‰
                key = new_site.get('key', '')
                if key and key not in existing_keys:
                    existing_sites.append(new_site)
                    existing_keys.add(key)
                    
    except Exception as e:
        print(f'å¤„ç†æºæ–‡ä»¶å¤±è´¥: {e}')
        continue

# 4. æ›´æ–°ç›®æ ‡æ•°æ®ï¼ˆåªæ›´æ–°sitesï¼Œä¿ç•™å…¶ä»–æ‰€æœ‰é›†åˆï¼‰
target_data['sites'] = existing_sites

# ä¿å­˜æ–‡ä»¶
with open(target_file, 'w', encoding='utf-8') as f:
    json.dump(target_data, f, ensure_ascii=False, indent=2)

print('âœ… åˆå¹¶å®Œæˆ')
print(f'ğŸ“Š æ€»ç«™ç‚¹æ•°: {len(existing_sites)}')
"

    - name: Verify results
      run: |
        cd bingo-tv
        python3 -c "
import json
try:
    with open('ç»¼åˆå½±è§†.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    sites = data.get('sites', [])
    print(f'âœ… ç«™ç‚¹æ€»æ•°: {len(sites)}')
    
    # æ£€æŸ¥jarå­—æ®µ
    jars = set()
    for site in sites[:5]:
        jar = site.get('jar', 'æ— jar')
        name = site.get('name', 'æœªçŸ¥')
        if jar and jar.startswith('http'):
            jars.add(jar)
            print(f'âœ… {name}: æœ‰jarå­—æ®µ')
        else:
            print(f'âŒ {name}: æ— jarå­—æ®µ')
    
    print(f'ä½¿ç”¨çš„jaråœ°å€: {list(jars)}')
    
    # æ£€æŸ¥å…¶ä»–é›†åˆæ˜¯å¦ä¿ç•™
    other_fields = [k for k in data.keys() if k != 'sites']
    print(f'ä¿ç•™çš„å…¶ä»–é›†åˆ: {other_fields}')
    
except Exception as e:
    print(f'éªŒè¯é”™è¯¯: {e}')
"

    - name: Commit changes
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        cd bingo-tv
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add ç»¼åˆå½±è§†.json
        git commit -m "Complete: Merge sites with jars and fixed paths"
        git push origin main
        echo "âœ… æ›´æ”¹å·²æäº¤"
