name: Fix Relative Paths

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  fix-paths:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: leexuben/BINGO-TV
        path: bingo-tv
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Fix relative paths script
      run: |
        cd bingo-tv
        python3 << "EOF"
import json
import os

SOURCE_FILE = "ç»¼åˆå½±è§†.json"
TARGET_FILE = "ç»¼åˆå½±è§†.json"

# åŸºç¡€URLé…ç½®
BASE_URLS = {
    "ç‹äºŒå°": "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/ç‹äºŒå°/",
    "æ½‡æ´’": "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/æ½‡æ´’/",
    "å·§æŠ€": "https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/å·§æŠ€/",
    "å½±è§†": "https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/"
}

def fix_relative_paths(sites):
    fixed_count = 0
    for site in sites:
        jar_url = site.get('jar', '')
        base_url = None
        
        # æ ¹æ®jar URLåˆ¤æ–­æ¥æº
        if 'ç‹äºŒå°' in jar_url:
            base_url = BASE_URLS['ç‹äºŒå°']
        elif 'æ½‡æ´’' in jar_url:
            base_url = BASE_URLS['æ½‡æ´’']
        elif 'å·§æŠ€' in jar_url:
            base_url = BASE_URLS['å·§æŠ€']
        elif 'ljlfct01' in jar_url:
            base_url = BASE_URLS['å½±è§†']
        else:
            continue  # å¦‚æœæ²¡æœ‰åŒ¹é…çš„jaræ¥æºï¼Œè·³è¿‡æ­¤ç«™ç‚¹
        
        # ä¿®å¤ api å­—æ®µ
        if 'api' in site and isinstance(site['api'], str) and site['api'].startswith('./'):
            original_path = site['api']
            site['api'] = base_url + original_path[2:]
            fixed_count += 1
            print(f"  ä¿®å¤ api: {original_path} -> {site['api']}")

        # ä¿®å¤ ext å­—æ®µ
        if 'ext' in site and isinstance(site['ext'], str) and site['ext'].startswith('./'):
            original_path = site['ext']
            site['ext'] = base_url + original_path[2:]
            fixed_count += 1
            print(f"  ä¿®å¤ ext: {original_path} -> {site['ext']}")
            
    return fixed_count

def main():
    print("ğŸš€ å¼€å§‹ä¿®å¤ç›¸å¯¹è·¯å¾„...")
    print("=" * 60)
    
    try:
        with open(SOURCE_FILE, 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # å¤„ç†æ•°æ®æ ¼å¼ï¼šå¯èƒ½æ˜¯å¯¹è±¡ï¼ˆåŒ…å«sitesé”®ï¼‰æˆ–ç›´æ¥æ˜¯ç«™ç‚¹åˆ—è¡¨
        if isinstance(data, dict) and 'sites' in data:
            print("ğŸ“Š æ£€æµ‹åˆ°å¯¹è±¡æ ¼å¼ï¼Œå¤„ç†'sites'é”®")
            sites = data['sites']
            other_data = {k: v for k, v in data.items() if k != 'sites'}
        elif isinstance(data, list):
            print("ğŸ“Š æ£€æµ‹åˆ°æ•°ç»„æ ¼å¼")
            sites = data
            other_data = {}
        else:
            print("âŒ æ— æ³•è¯†åˆ«çš„JSONç»“æ„")
            return False
        
        print(f"ğŸ“Š æ‰¾åˆ° {len(sites)} ä¸ªç«™ç‚¹")
        
        fixed_count = fix_relative_paths(sites)
        print(f"âœ… ä¿®å¤äº† {fixed_count} ä¸ªç›¸å¯¹è·¯å¾„")
        
        # é‡æ–°æ„å»ºå®Œæ•´æ•°æ®ï¼Œç¡®ä¿å…¶ä»–é›†åˆä¸è¢«æ”¹åŠ¨
        if other_data:
            result_data = other_data
            result_data['sites'] = sites
        else:
            result_data = sites
        
        with open(TARGET_FILE, 'w', encoding='utf-8') as f:
            json.dump(result_data, f, ensure_ascii=False, indent=2)
        
        print("=" * 60)
        print("ğŸ“‹ ä¿®å¤å®Œæˆï¼Œæ–‡ä»¶å·²ä¿å­˜ã€‚")
        return True
        
    except Exception as e:
        print(f"âŒ å¤„ç†æ–‡ä»¶å¤±è´¥: {e}")
        return False

if __name__ == "__main__":
    main()
EOF

    - name: Commit and push changes
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        cd bingo-tv
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/leexuben/BINGO-TV.git
        git add ç»¼åˆå½±è§†.json
        if git diff --cached --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
          exit 0
        fi
        git commit -m "Fix: Convert relative paths to absolute URLs $(date +'%Y-%m-%d %H:%M:%S')"
        git push origin main
        echo "âœ… ç›¸å¯¹è·¯å¾„ä¿®å¤å®Œæˆå¹¶å·²æ¨é€"
