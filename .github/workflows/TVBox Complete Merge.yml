name: TVBox Complete Merge

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  complete-merge:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: leexuben/BINGO-TV
        path: bingo-tv
        token: ${{ secrets.GH_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests

    - name: Merge and fix sites
      run: |
        cd bingo-tv
        python3 -c "
import json
import requests

# 源文件配置
sources = [
    {
        'url': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/王二小/api.json',
        'jar': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/王二小/spider.jar',
        'base': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/王二小/'
    },
    {
        'url': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/潇洒/api.json',
        'jar': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/潇洒/spider.jar',
        'base': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/潇洒/'
    },
    {
        'url': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/巧技/api.json',
        'jar': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/巧技/spider.jar',
        'base': 'https://raw.githubusercontent.com/leexuben/TV-BOX/main/t极狐/巧技/'
    },
    {
        'url': 'https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/影视',
        'jar': 'https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/jar/spider.jar',
        'base': 'https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/'
    }
]

target_file = '综合影视.json'

# 读取目标文件
try:
    with open(target_file, 'r', encoding='utf-8') as f:
        target_data = json.load(f)
except:
    target_data = {}

# 确保有sites数组
if 'sites' not in target_data:
    target_data['sites'] = []

existing_sites = target_data['sites']
existing_keys = {site.get('key', '') for site in existing_sites}

# 处理每个源文件
for source in sources:
    try:
        response = requests.get(source['url'], timeout=30)
        if response.status_code == 200:
            content = response.text
            try:
                data = json.loads(content)
                sites = data.get('sites', []) if isinstance(data, dict) else data
                
                for site in sites:
                    # 复制站点数据
                    new_site = site.copy()
                    
                    # 添加jar（如果没有）
                    if 'jar' not in new_site or not new_site['jar']:
                        new_site['jar'] = source['jar']
                    
                    # 修复相对路径
                    if 'api' in new_site and isinstance(new_site['api'], str) and new_site['api'].startswith('./'):
                        new_site['api'] = source['base'] + new_site['api'][2:]
                    
                    if 'ext' in new_site and isinstance(new_site['ext'], str) and new_site['ext'].startswith('./'):
                        new_site['ext'] = source['base'] + new_site['ext'][2:]
                    
                    # 去重添加
                    key = new_site.get('key', '')
                    if key and key not in existing_keys:
                        existing_sites.append(new_site)
                        existing_keys.add(key)
                        
            except json.JSONDecodeError:
                pass
    except requests.RequestException:
        pass

# 更新目标数据（保留所有其他集合）
target_data['sites'] = existing_sites

# 保存文件
with open(target_file, 'w', encoding='utf-8') as f:
    json.dump(target_data, f, ensure_ascii=False, indent=2)

print('合并完成')
"

    - name: Commit changes
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        cd bingo-tv
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add 综合影视.json
        if git diff --cached --quiet; then
          echo "没有更改"
        else
          git commit -m "Merge: Complete sites update with jars and fixed paths"
          git push origin main
          echo "更新完成"
        fi
