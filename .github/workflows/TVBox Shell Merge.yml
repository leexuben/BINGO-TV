name: TVBox Full Merge with Jar

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  full-merge:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: leexuben/BINGO-TV
        path: bingo-tv
        token: ${{ secrets.GH_TOKEN }}

    - name: Install jq and curl
      run: sudo apt-get update && sudo apt-get install -y jq curl

    - name: Merge with full jar support
      run: |
        cd bingo-tv
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p temp
        
        # æºæ–‡ä»¶é…ç½®ï¼ˆåŒ…å«jaråœ°å€ï¼‰
        sources=(
          "ç‹äºŒå°|https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/ç‹äºŒå°/api.json|https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/ç‹äºŒå°/spider.jar|https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/ç‹äºŒå°/"
          "æ½‡æ´’|https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/æ½‡æ´’/api.json|https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/æ½‡æ´’/spider.jar|https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/æ½‡æ´’/"
          "å·§æŠ€|https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/å·§æŠ€/api.json|https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/å·§æŠ€/spider.jar|https://raw.githubusercontent.com/leexuben/TV-BOX/main/tvbox/å·§æŠ€/"
          "å½±è§†|https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/å½±è§†|https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/jar/spider.jar|https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/main/"
        )
        
        # ä¸‹è½½æºæ–‡ä»¶å¹¶å¤„ç†
        for source in "${sources[@]}"; do
          IFS='|' read -r name url jar base <<< "$source"
          echo "å¤„ç†: $name"
          
          if curl -s -o "temp/${name}_raw.json" "$url"; then
            if jq empty "temp/${name}_raw.json" 2>/dev/null; then
              # æ·»åŠ jarå­—æ®µå¹¶ä¿®å¤è·¯å¾„
              jq '
                def fix_paths(obj, base_url):
                  obj | walk(
                    if type == "object" then
                      . | to_entries | map(
                        if .key == "api" and .value | type == "string" and .value | startswith("./") then
                          {key: .key, value: base_url + (.value | .[2:])}
                        elif .key == "ext" and .value | type == "string" and .value | startswith("./") then
                          {key: .key, value: base_url + (.value | .[2:])}
                        else
                          .
                        end
                      ) | from_entries
                    else
                      .
                    end
                  );
                
                if type == "array" then
                  map(. + {jar: "'"$jar"'"} | fix_paths(.; "'"$base"'"))
                elif type == "object" and has("sites") then
                  .sites |= map(. + {jar: "'"$jar"'"} | fix_paths(.; "'"$base"'"))
                else
                  .
                end
              ' "temp/${name}_raw.json" > "temp/${name}_processed.json"
              
              echo "âœ… $name å¤„ç†æˆåŠŸ"
            else
              echo "âŒ $name JSONæ ¼å¼é”™è¯¯ï¼Œè·³è¿‡"
            fi
          else
            echo "âŒ $name ä¸‹è½½å¤±è´¥"
          fi
        done
        
        # è¯»å–ç›®æ ‡æ–‡ä»¶
        if [ -f "ç»¼åˆå½±è§†.json" ] && jq empty "ç»¼åˆå½±è§†.json" 2>/dev/null; then
          cp "ç»¼åˆå½±è§†.json" temp/target.json
        else
          echo '{}' > temp/target.json
        fi
        
        # åˆå¹¶æ‰€æœ‰å¤„ç†åçš„æºæ–‡ä»¶
        echo '[]' > temp/all_sites.json
        
        for file in temp/*_processed.json; do
          if [ -f "$file" ] && [ -s "$file" ]; then
            echo "åˆå¹¶: $(basename $file)"
            if jq '
              if type == "array" then . 
              elif type == "object" and has("sites") then .sites
              else []
              end
            ' "$file" > temp/current_sites.json 2>/dev/null; then
              
              jq '. + input' temp/all_sites.json temp/current_sites.json > temp/combined.json
              mv temp/combined.json temp/all_sites.json
            fi
          fi
        done
        
        # å»é‡ï¼ˆåŸºäºkeyå­—æ®µï¼‰
        jq '
          group_by(.key) | map(.[0])
        ' temp/all_sites.json > temp/unique_sites.json
        
        # æ›´æ–°ç›®æ ‡æ–‡ä»¶ï¼ˆåªæ›¿æ¢siteså­—æ®µï¼‰
        jq '.sites = input' temp/target.json temp/unique_sites.json > "ç»¼åˆå½±è§†.json"
        
        # ç»Ÿè®¡ä¿¡æ¯
        total_count=$(jq 'length' temp/all_sites.json)
        unique_count=$(jq '.sites | length' "ç»¼åˆå½±è§†.json")
        jar_count=$(jq '.sites | map(select(.jar)) | length' "ç»¼åˆå½±è§†.json")
        
        echo "âœ… åˆå¹¶å®Œæˆ!"
        echo "ğŸ“Š æ€»ç«™ç‚¹: $total_count, å»é‡å: $unique_count"
        echo "ğŸ“¦ æœ‰jarå­—æ®µ: $jar_count"
        
        # æ¸…ç†
        rm -rf temp

    - name: Verify results
      run: |
        cd bingo-tv
        echo "=== éªŒè¯ç»“æœ ==="
        echo "æ–‡ä»¶å¤§å°: $(wc -c < ç»¼åˆå½±è§†.json) bytes"
        echo "ç«™ç‚¹æ•°é‡: $(jq '.sites | length' ç»¼åˆå½±è§†.json)"
        echo "æœ‰jarå­—æ®µçš„ç«™ç‚¹: $(jq '.sites | map(select(.jar)) | length' ç»¼åˆå½±è§†.json)"
        
        # æ˜¾ç¤ºå‰3ä¸ªç«™ç‚¹çš„jarå­—æ®µ
        echo "=== å‰3ä¸ªç«™ç‚¹çš„jarå­—æ®µ ==="
        jq '.sites[0:3] | map({name: .name, jar: .jar})' ç»¼åˆå½±è§†.json

    - name: Commit changes
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        cd bingo-tv
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add ç»¼åˆå½±è§†.json
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ›´æ”¹"
          exit 0
        fi
        git commit -m "Merge: Sites with jar fields"
        git push origin main
        echo "âœ… æ›´æ”¹å·²æäº¤"
