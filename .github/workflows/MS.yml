on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  merge-sites:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: leexuben/BINGO-TV
        path: bingo-tv
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests

    - name: Run merge script
      run: |
        python << 'EOF'
        import json
        import requests
        import re

        SOURCE_CONFIGS = [
            {
                "api_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/王二小/api.json",
                "jar_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/王二小/spider.jar"
            },
            {
                "api_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/潇洒/api.json", 
                "jar_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/潇洒/spider.jar"
            },
            {
                "api_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/巧技/api.json",
                "jar_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/巧技/spider.jar"
            },
            {
                "api_url": "https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/refs/heads/main/影视",
                "jar_url": "https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/refs/heads/main/jar/spider.jar"
            }
        ]
        
        TARGET_FILE = "bingo-tv/综合影视.json"

        def extract_sites(content):
            try:
                data = json.loads(content)
                return data.get('sites', [])
            except:
                try:
                    json_start = content.find('{')
                    json_end = content.rfind('}') + 1
                    if json_start != -1:
                        data = json.loads(content[json_start:json_end])
                        return data.get('sites', [])
                except:
                    try:
                        match = re.search(r'"sites"\s*:\s*\[(.*?)\]', content, re.DOTALL)
                        if match:
                            return json.loads(f'[{match.group(1)}]')
                    except:
                        pass
            return []

        all_sites = []
        
        for config in SOURCE_CONFIGS:
            try:
                response = requests.get(config["api_url"], timeout=30)
                content = response.text
                sites = extract_sites(content)
                
                for site in sites:
                    if 'jar' not in site or not site['jar']:
                        site['jar'] = config["jar_url"]
                    all_sites.append(site)
                    
            except Exception as e:
                pass

        # 去重
        unique_sites = []
        seen_keys = set()
        
        for site in all_sites:
            key = site.get('key', '')
            if key not in seen_keys:
                unique_sites.append(site)
                seen_keys.add(key)

        # 直接保存数组
        with open(TARGET_FILE, 'w', encoding='utf-8') as f:
            json.dump(unique_sites, f, ensure_ascii=False, indent=2)

        EOF

    - name: Commit and push
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        cd bingo-tv
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/leexuben/BINGO-TV.git
        git fetch origin
        git reset --hard origin/main
        git add .
        git commit -m "Update: $(date +'%Y-%m-%d %H:%M:%S')" || exit 0
        git push origin main
