on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  merge-sites:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repo
      uses: actions/checkout@v4
      with:
        repository: leexuben/BINGO-TV
        path: bingo-tv
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests

    - name: Run merge script
      run: |
        python << 'EOF'
        import json
        import requests
        import re
        from datetime import datetime
        import os

        # æºæ–‡ä»¶URLåˆ—è¡¨
        SOURCE_URLS = [
            "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/ç‹äºŒå°/api.json",
            "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/æ½‡æ´’/api.json",
            "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/å·§æŠ€/api.json",
            "https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/refs/heads/main/å½±è§†"
        ]
        
        # ç›®æ ‡æ–‡ä»¶è·¯å¾„
        TARGET_FILE = "bingo-tv/ç»¼åˆå½±è§†.json"

        def extract_json_from_xml(content):
            """ä»XMLå†…å®¹ä¸­æå–JSONæ•°æ®"""
            try:
                # æŸ¥æ‰¾JSONå¼€å§‹å’Œç»“æŸä½ç½®
                json_start = content.find('{')
                json_end = content.rfind('}') + 1
                
                if json_start != -1 and json_end > json_start:
                    json_content = content[json_start:json_end]
                    return json.loads(json_content)
                return None
            except Exception as e:
                print(f"XMLæå–å¤±è´¥: {e}")
                return None

        def extract_sites_with_regex(content):
            """ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–sitesæ•°ç»„"""
            try:
                # åŒ¹é… "sites": [ ... ] æ¨¡å¼ï¼Œæ”¯æŒå„ç§æ ¼å¼
                pattern = r'"sites"\s*:\s*\[(.*?)\]'
                match = re.search(pattern, content, re.DOTALL)
                
                if match:
                    sites_content = match.group(1)
                    # å°è¯•æ„å»ºå®Œæ•´çš„JSONæ•°ç»„
                    full_array = f'[{sites_content}]'
                    return json.loads(full_array)
            except Exception as e:
                print(f"æ­£åˆ™æå–å¤±è´¥: {e}")
            
            return []

        def fetch_and_extract_sites(url):
            """è·å–URLå†…å®¹å¹¶æå–sitesæ•°æ®"""
            try:
                print(f"ğŸ“¥ è·å–: {url}")
                response = requests.get(url, timeout=30)
                response.raise_for_status()
                
                content = response.text
                print(f"   âœ… è·å–æˆåŠŸï¼Œé•¿åº¦: {len(content)} å­—ç¬¦")
                
                # æ–¹æ³•1: å°è¯•ç›´æ¥è§£æJSON
                try:
                    data = json.loads(content)
                    sites = data.get('sites', [])
                    if sites:
                        print(f"   âœ… ç›´æ¥è§£æè·å– {len(sites)} ä¸ªç«™ç‚¹")
                        return sites
                except:
                    pass
                
                # æ–¹æ³•2: å¤„ç†XMLåŒ…è£…çš„JSON
                xml_data = extract_json_from_xml(content)
                if xml_data:
                    sites = xml_data.get('sites', [])
                    if sites:
                        print(f"   âœ… XMLæå–è·å– {len(sites)} ä¸ªç«™ç‚¹")
                        return sites
                
                # æ–¹æ³•3: ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–
                sites = extract_sites_with_regex(content)
                if sites:
                    print(f"   âœ… æ­£åˆ™æå–è·å– {len(sites)} ä¸ªç«™ç‚¹")
                    return sites
                
                print(f"   âš ï¸  æœªæ‰¾åˆ°sitesæ•°æ®")
                return []
                
            except Exception as e:
                print(f"   âŒ å¤„ç†å¤±è´¥: {e}")
                return []

        def main():
            print("ğŸš€ å¼€å§‹åˆå¹¶ç«™ç‚¹æ•°æ®...")
            print("=" * 60)
            
            all_sites = []
            processed_files = []
            
            # å¤„ç†æ‰€æœ‰æºæ–‡ä»¶
            for url in SOURCE_URLS:
                sites = fetch_and_extract_sites(url)
                if sites:
                    all_sites.extend(sites)
                    processed_files.append({
                        "url": url,
                        "sites_count": len(sites)
                    })
                    print(f"   ğŸ“Š å½“å‰ç´¯è®¡: {len(all_sites)} ä¸ªç«™ç‚¹")
                print("-" * 40)
            
            if not all_sites:
                print("âŒ æœªæå–åˆ°ä»»ä½•ç«™ç‚¹æ•°æ®")
                return
            
            # å»é‡å¤„ç†ï¼ˆåŸºäºkeyå­—æ®µï¼‰
            unique_sites = []
            seen_keys = set()
            duplicate_count = 0
            
            for site in all_sites:
                key = site.get('key', '')
                if key and key in seen_keys:
                    duplicate_count += 1
                    continue
                
                unique_sites.append(site)
                if key:
                    seen_keys.add(key)
            
            print("=" * 60)
            print("ğŸ“Š åˆå¹¶ç»Ÿè®¡:")
            print(f"   æ€»ç«™ç‚¹æ•°: {len(all_sites)}")
            print(f"   å»é‡åç«™ç‚¹æ•°: {len(unique_sites)}")
            print(f"   é‡å¤ç«™ç‚¹æ•°: {duplicate_count}")
            print(f"   æˆåŠŸå¤„ç†æ–‡ä»¶æ•°: {len(processed_files)}")
            
            # æŒ‰ç±»å‹ç»Ÿè®¡
            type_stats = {}
            for site in unique_sites:
                site_type = site.get('type', 'unknown')
                type_stats[site_type] = type_stats.get(site_type, 0) + 1
            
            print(f"\nğŸ“‹ ç«™ç‚¹ç±»å‹ç»Ÿè®¡:")
            for site_type, count in sorted(type_stats.items()):
                print(f"   type {site_type}: {count} ä¸ªç«™ç‚¹")
            
            # åˆ›å»ºåˆå¹¶ç»“æœ
            result_data = {
                "sites": unique_sites,
                "metadata": {
                    "description": "è‡ªåŠ¨åˆå¹¶çš„å½±è§†ç«™ç‚¹é›†åˆ",
                    "total_sites": len(unique_sites),
                    "processed_files": processed_files,
                    "source_count": len(SOURCE_URLS),
                    "last_updated": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                    "workflow_run": os.getenv("GITHUB_RUN_ID", "unknown")
                }
            }
            
            # ä¿å­˜åˆ°ç›®æ ‡æ–‡ä»¶
            with open(TARGET_FILE, 'w', encoding='utf-8') as f:
                json.dump(result_data, f, ensure_ascii=False, indent=2)
            
            print(f"\nâœ… åˆå¹¶å®Œæˆ! ç»“æœå·²ä¿å­˜åˆ°: {TARGET_FILE}")
            
            # æ˜¾ç¤ºå‰å‡ ä¸ªç«™ç‚¹ç¤ºä¾‹
            print(f"\nğŸ” å‰3ä¸ªç«™ç‚¹ç¤ºä¾‹:")
            for i, site in enumerate(unique_sites[:3]):
                name = site.get('name', 'æœªçŸ¥åç§°')
                key = site.get('key', 'æ— key')
                site_type = site.get('type', 'æœªçŸ¥ç±»å‹')
                print(f"   {i+1}. {name}")
                print(f"      key: {key}, type: {site_type}")

        if __name__ == "__main__":
            main()
        EOF

    - name: Commit and push changes
      run: |
        cd bingo-tv
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --quiet --exit-code; then
          echo "ğŸ“ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          exit 0
        fi
        
        # æ‹‰å–æœ€æ–°æ›´æ”¹å¹¶æäº¤
        git pull origin main --rebase
        git add ç»¼åˆå½±è§†.json
        git commit -m "Auto-update: Merged sites data [$(date +'%Y-%m-%d %H:%M')]"
        git push origin main
        echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
