on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  merge-sites:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: leexuben/BINGO-TV
        path: bingo-tv
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests

    - name: Run merge script
      run: |
        python << 'EOF'
        import json
        import requests
        import re
        import os

        SOURCE_CONFIGS = [
            {
                "api_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/王二小/api.json",
                "jar_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/王二小/spider.jar"
            },
            {
                "api_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/潇洒/api.json",
                "jar_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/潇洒/spider.jar"
            },
            {
                "api_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/巧技/api.json",
                "jar_url": "https://raw.githubusercontent.com/leexuben/TV-BOX/refs/heads/main/tvbox/巧技/spider.jar"
            },
            {
                "api_url": "https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/refs/heads/main/影视",
                "jar_url": "https://raw.githubusercontent.com/leexuben/ljlfct01.github.io/refs/heads/main/jar/spider.jar"
            }
        ]
        
        TARGET_FILE = "bingo-tv/综合影视.json"

        def extract_sites(content):
            try:
                data = json.loads(content)
                return data.get('sites', [])
            except:
                try:
                    json_start = content.find('{')
                    json_end = content.rfind('}') + 1
                    if json_start != -1:
                        data = json.loads(content[json_start:json_end])
                        return data.get('sites', [])
                except:
                    try:
                        match = re.search(r'"sites"\s*:\s*\[(.*?)\]', content, re.DOTALL)
                        if match:
                            return json.loads(f'[{match.group(1)}]')
                    except:
                        pass
            return []

        all_sites = []
        
        for config in SOURCE_CONFIGS:
            try:
                response = requests.get(config["api_url"], timeout=30)
                response.raise_for_status()
                content = response.text
                sites = extract_sites(content)
                
                print(f"从 {config['api_url']} 提取到 {len(sites)} 个站点")
                
                for site in sites:
                    # 只为没有jar的站点添加jar
                    if 'jar' not in site or not site['jar']:
                        site['jar'] = config["jar_url"]
                    
                    all_sites.append(site)
                    
            except Exception as e:
                print(f"处理 {config['api_url']} 失败: {e}")

        # 去重
        unique_sites = []
        seen_keys = set()
        
        for site in all_sites:
            key = site.get('key', '')
            if key not in seen_keys:
                unique_sites.append(site)
                seen_keys.add(key)

        print(f"合并完成: 总{len(all_sites)}个站点, 去重后{len(unique_sites)}个")

        # 直接保存数组
        with open(TARGET_FILE, 'w', encoding='utf-8') as f:
            json.dump(unique_sites, f, ensure_ascii=False, indent=2)

        EOF

    - name: Check file changes
      run: |
        cd bingo-tv
        echo "=== 文件状态 ==="
        ls -la
        echo "=== 文件内容检查 ==="
        head -20 综合影视.json
        echo "=== Git 状态 ==="
        git status

    - name: Commit and push changes
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        cd bingo-tv
        
        # 配置Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/leexuben/BINGO-TV.git
        
        # 检查文件差异
        echo "=== 文件差异 ==="
        git diff 综合影视.json || echo "无差异"
        
        # 添加文件
        git add 综合影视.json
        
        # 检查是否有更改
        if git diff --cached --quiet; then
          echo "❌ 没有检测到更改，文件可能没有更新"
          exit 1
        fi
        
        # 提交并推送
        git commit -m "Auto-update: Merged sites data $(date +'%Y-%m-%d %H:%M:%S')"
        git push origin main
        
        echo "✅ 文件已成功更新并推送"
